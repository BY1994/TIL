

# 2024-03-25 (Compile Debugging)

**디버깅 내역**

선언하지 않은 함수를 호출했는데도 펌웨어의 빌드 에러가 발생하지 않았다. 파일이 빌드되지 않은 것을 의심하고 일부러 문법 오류를 내면 빌드 에러가 발생했다. 컴파일 옵션에 의해 함수가 제거되었기 때문에 링커 단계에서 문제가 없이 넘어갔던 것이었다. 라이브러리 내에 함수가 있는 것인가 의심했는데 아니었다.

// Makefile

```makefile
CPU = -march=armv8-a -mcpu=cortex-a57 -Wstrict-prototypes -Wno-trigraphs -fno-strict-aliasing -fno-common // 생략
CFLAG += $(CPU) -w -g -std=c99 -nostdlib -fdata-sections -ffunction-sections -O0 $(INC)

LD_LIB_OPTION := -L. -l$(LIBS) --gc-sections
```

CFLAG 에 `-ffunction-sections` 를 제거하고 LD_LIB_OPTION 의 `--gc-sections` 를 제거해야 해결되었다.



**컴파일러 옵션 정리**

https://blog.naver.com/seojongbeom/220907637623

| C Compiler Optimization |                                                              |                                                              |
| ----------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 옵션                    | 설명                                                         | 비고                                                         |
| -O0                     | 아무런 작업을 하지 않음                                      |                                                              |
| -Os                     | -O2에서 제공하는 모든 최적화 기능을 다 사용하지만, 코드의 크기를 증가시키는 최적화 기능은 빼고 나서 최적화를 수행 한다. |                                                              |
| -O1                     | 만들어지는 오브젝트, 또는 실행 파일을 가능한 작게 하면서, 컴파일 시간이 오래 걸리지 않는 범위에서 최적화를 수행 한다. |                                                              |
| -O2                     | 만들어지는 코드가 가능한 빠르게 수행되도록 하지만, 코드의 크기가 너무 거지지 않도록 하는 범위에서 최적화를 수행 한다. | -O2 인라인 함수에 대해서는 최적화 작업을 하지 않는다. 인라인 함수도 함께 최적화를 하고 싶을 경우에는 -finline-functions 옵션을 함께 사용해야 한다. |
| -O3                     | 코드의 크기는 전혀 신경쓰지 않고, 오직 빠른 코드를 만들어 내기 위해 최적화를 수행 한다. 그러나, 꼭 생각해 두어야 할 점은, -O2옵션을 사용한 것보다 빠르다는 것에대한 보장은 없다. 이것은 CPU에서 재공되는 내부 캐쉬에서 명령어를 사전에 읽어들여 처리하는 부분에 있어서 명령어를 전부 담지 못할 경우에 오히려 느려질 가능성도 있다. | -O3 에서는 인라인 함수에 대한 최적화도 함께 진행이 된다. 이때 인라인 함수에 대한 최적화를 진행하지 않기를 바란다면 -fno-inline-functions 옵션을 추가 한다. |
| -Og                     | 디버깅 정보를 담는 옵션                                      |                                                              |
| -finline-fucntions      | 인라인 함수에 대한 최적화                                    | -O3에서는 기본으로 포함.                                     |
| -fno-inline-functions   | 인라인 함수에 대한 최적화를 진행하지 않음                    | -O3에서 이에 대한 부분만 뺄 경우 사용                        |
| -ffunction-sections     | 사용하지 않는 함수에 대해서 제거를 진행 한다.                | 컴파일 과정에서 속도가 증가될 수 있다.링커 옵션에서 -Wl,--gc-sections와 함께 사용해야 최종 결과물에 효과를 볼수 있다. |
| -fdata-sections         | 사용하지 않는 데이터를 제거할 때 사용 한다.                  | 컴파일 과정에서 속도가 증가될 수 있다..경우에 따라서는 실제 결과물이 더 큰 크기가 될 수 있다. 링커옵션에서 -Wl,--gc-sections와 함께 사용되어야 한다. |
| -f[option]              | 컴파일러 옵션을 지정할 때 사용 한다.                         |                                                              |
| -fno-[option]           | 해당 옵션을 적용하지 않을 때 사용 한다.                      |                                                              |



**Linker 옵션**

| C/C++ Linker Options  |                                                              |                                                      |
| --------------------- | ------------------------------------------------------------ | ---------------------------------------------------- |
| 옵션                  | 내용                                                         | 비고                                                 |
| -nostartfiles         | 표준 시작 파일을 사용하지 않는다.                            |                                                      |
| -noodefaultlibs       | 기본 라이브러리를 사용하지 않는다.                           |                                                      |
| -nostdlib             | startup 혹은 기본라이브러리를 사용하지 않는다.               |                                                      |
| -s                    | 모든 심복정보를 생략한다.                                    |                                                      |
| -T[scatter file path] | 링크 스크립트(스캐터) 파일의 경로를 지정 한다.               |                                                      |
| -Wl,-Map=[output map] | 생성된 결과물의 구조 정보 파일을 생성 한다.                  |                                                      |
| -Wl,--gc-sections     | 사용하지 않는 세션에 해당 되는 정보를 제거하고 결과물을 생성 한다.  -ffunction-sections, -fdata-sections 를 사용하여 빌드된 오브젝트에서 사용하지 않는 것들을 제거한다. | -ffunction-sections, -fdata-sections 와 함께 사용됨. |
| -fno-exceptions       | 예외 처리 기능을 사용하지 않는다.                            | c++ 에서만 사용됨.                                   |
| -fno-rtti             | 동작중인 상태에서 클래스 타입에 대한 정보를 식별할 수 있게 해준다. | c++ 에서만 사용됨.                                   |
| -l                    | 링크되는 라이브러리의 이름을 지정 한다. ( 소문자 L )         |                                                      |
| -L                    | 링크되는 라이브러리가 존재하는 경로를 지정 한다.             |                                                      |
| -shared               | 생성되는 결과물을 공용 라이브러리를 만들 때 사용하는 옵션    |                                                      |
| -Wl,-soname           | 공용 라이브러리의 이름을 지정 한다.                          |                                                      |
| -Wl,--out-implib      |                                                              |                                                      |
| -Wl,--output-def      |                                                              |                                                      |



\-function-section & \-fdata-sections 옵션 질문

https://stackoverflow.com/questions/4274804/query-on-ffunction-section-fdata-sections-options-of-gcc

